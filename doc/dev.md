# 开发过程

## 为什么想做这样一个工具

随着一些标志性事件的发生，国内版权意识逐渐“觉醒”，但这个觉醒的版权可能和我的理解不太一样。

在我朴素的观念里，版权是保障原创作者权益的约定，比如代码库里的license。  
但国内的版权，已经变成了保护获益人/资本的借口，举几个例子：

1. 《神探狄仁杰》核心制作人钱雁秋，因为所谓版权问题，在第4部作品中无法使用《神探狄仁杰4》作为名字，只能改用《神断狄仁杰》
2. 知名网络小说网站起点，签约合同中将小说作者创作内容的版权据为己有，使创作者变成了自带创意的枪手
3. 知名网络小说网站起点，在网站订阅作品，实际上只获得了15天的阅读权，15天之后，网站甚至可以随意删除你购买的内容
4. 某知名主播因直播期间演唱某歌曲，被版权方索赔10万元，从此事件中还诞生了一批经典语录，如“索要的赔偿金额其实不重要，我们主要是希望唤起大家保护版权的意识”等

综上所述，“版权”原本神圣的光环，在我眼中逐渐褪色，我也不再重视任何我无法从中获益的版权问题。  
当然了，以上内容也可以解释成我为自己心安理得地看盗版小说、听无版权音乐找的借口，我也认可这种思路。

又因为我在一些场景中确实有听音乐的需求——比如做家务的时候，而现有音乐播放器或多或少都不符合我的情况：

1. 网易云、酷狗等播放器因为版权问题，部分歌曲直接没有，即使今天有的歌曲，可能明天就没了
2. [listen1](https://github.com/listen1/listen1_desktop)，我在使用期间经常遇到歌曲消失的情况：一首4分钟的歌，直接变成15s的“……请到酷我音乐手机端播放……”
3. B站，在一个100首歌的合集里找到一首自己不喜欢的歌可太简单了，  
   B站听歌的问题在于up主上传什么、我就得听什么，没有办法跳过一首歌、修改播放顺序、修改音量等

所以我产生了自己写一个听歌工具的想法，它应该有这些功能：

1. 能根据B站链接播放音频或视频
2. 能操作歌单，包括新增、删除、排序等

## 技术准备

网络上找到的主要是**将B站视频下载到本地**的方法，偶尔有附带在线播放功能的，也不符合我的使用场景，决定自己写。

从网络上找到一种获取B站视频源地址的方法：模拟移动端调用，在html文件中就带有视频源地址，这个源地址作为url，可以在新的浏览器标签页中直接播放。
同时，因为这个源地址是视频格式，以至于我最初的想法——只播放音频就不合适了。  
技术上没有障碍了，整体的思路是：根据bv地址获取源地址 - 使用源地址播放视频。

为了方便描述，我们约定：

1. bv地址：
    - 形如`https://m.bilibili.com/video/BV1nk4y1P79g?p=22` 的链接
    - B站视频的公开地址
2. 源地址：
    - 形如
   ```text
   https://cn-hk-eq-01-14.bilivideo.com/upgcxcode/11/44/1190394411/1190394411-1-16.mp4
   ?e=ig8euxZM2rNcNbRVhwdVhwdlhWdVhwdVhoNvNC8BqJIzNbfq9rVEuxTEnE8L5F6VnEsSTx0vkX8fqJeYTj_lta53NCM=
   &uipk=5
   &nbs=1
   &deadline=1692035857
   &gen=playurlv2
   &os=bcache&oi=983052370
   &trid=00007c1bef8f8f0e424eb013d777b4aebf60h&mid=507453531
   &platform=html5
   &upsig=27967b89d0fa836e94ef28d0d279f9c4
   &uparams=e,uipk,nbs,deadline,gen,os,oi,trid,mid,platform
   &cdnid=68708&bvc=vod
   &nettype=0
   &bw=53263
   &logo=80000000
   ```
   的链接
    - B站视频源地址，可以直接当做url、通过浏览器使用

## 流程设计

1. go从指定路径获取歌单文件，反序列化，保存在程序内存
    1. 歌单文件里每一首歌应该包括：id、bv地址、声音（用于设置视频声音，当有两个视频，一个声音很大、一个声音很小的时候，这个值就有用了）
    2. 歌单里保存的声音，实际上是一个偏移量；前端会有一个可设置的统一音量（localstorage），  
       真正设置视频声音时，是在前端统一音量的基础上偏移每首歌的**声音**值;  
       考虑到电脑设置和人的差异，可能我在我的电脑上用30%统一音量正好，而你就需要40%，所以我们这个值在前端处理
    3. 一个歌单里可能有很多个播放列表
2. 前端请求歌单
3. 前端根据歌曲id请求视频源地址
4. 后端根据bv地址获取视频源地址，向前端返回**视频源地址**和**声音**
5. 前端得到视频源地址，播放视频；根据声音设置视频音量
    1. 前端注册视频播放结束事件：事件中继续请求下一个视频源地址

## 技术总结

1. 到最后遇到了技术问题：浏览器禁止自动播放声音（包括音频和非静音的视频），总结经验教训
   这个问题确实没有提前考虑到，想了一下，可能是我的需求过于*邪门*吧……  
   我甚至不知道下一次遇到类似的问题怎么提前考虑到，只能说下一次遇到一模一样的问题可能会想到吧。就像一些基础知识技能，不懂就是不懂。
2. **根据bv地址获取源地址**这一步，其实放在前端更合适，为什么做在了后端？
   我想要更多的使用go实现功能，web前端仅做展示。作为全栈程序员，如果非要分开，我更倾向于做后端。
3. 加载歌单和注册http请求响应函数，开始做在init阶段，为什么后来做到main阶段了？
   因为后来加入了启动参数(flag)模块，我认为，这个模块应该在加载歌单和注册响应函数之前执行——  
   这是合理的，因为启动参数执行期间，相当于程序本身还没有初始化完成，  
   而加载歌单等功能，应当划分为业务功能、理应在程序初始化完成之后执行。
   又因为go语言在执行**一批无依赖关系的init函数**时，其顺序是随机的（按照到编译器的顺序），  
   所以通过将加载歌单等功能调整到main阶段的方式，实现让业务功能后执行的效果。
4. 歌单文件的格式从json调整为yaml，遇到了哪些没有想到的问题？
   响应前端请求时，key拼写（大小写）错误。  
   这里介绍一些项目设定：http请求默认响应json，因为前端解析方便；json对象的key采用蛇形拼写（全小写+下划线，因为我在js中常这样使用）  
   我在一开始将歌单文件改成yaml格式时，直接删除了go结构体字段json tag，  
   这导致使用json marshal序列化的json key是驼峰拼写的，前端解析失败，所以后面又把结构体字段的json tag加回来了。
5. 为什么我在前端更多的使用蛇形拼写（全小写+下划线/横杠(`-`)）？
   我印象中前端一个很重要的东西是大小写不敏感的（好像是url？），我还踩过坑，  
   然后我在学习html/js/css的时候，就有意识地使用蛇形拼写，  
   即使现在使用vue框架，在定义html元素id、定义路由、定义css类名等场景中，也是习惯使用蛇形拼写，或者是把下划线换成`-`；很少使用驼峰拼写
